name: Tests & Release

on:
  push:
    branches: [ main, feature/*, release/*, fix/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bash-version: ['4.4', '5.0', '5.1', 'latest']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Bash ${{ matrix.bash-version }}
      run: |
        # If "latest" → use system bash
        if [ "${{ matrix.bash-version }}" = "latest" ]; then
          echo "Using system default Bash:"
          bash --version
          exit 0
        fi

        sudo apt-get update
        sudo apt-get install -y build-essential wget

        echo "Downloading Bash ${{ matrix.bash-version }}..."
        wget https://ftp.gnu.org/gnu/bash/bash-${{ matrix.bash-version }}.tar.gz
        tar -xzf bash-${{ matrix.bash-version }}.tar.gz
        cd bash-${{ matrix.bash-version }}

        echo "Compiling Bash..."
        ./configure --prefix=/usr/local/bash-${{ matrix.bash-version }}
        make
        sudo make install

        # Replace system bash temporarily
        sudo ln -sf /usr/local/bash-${{ matrix.bash-version }}/bin/bash /usr/local/bin/bash

        echo "Installed Bash version:"
        /usr/local/bin/bash --version
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          curl \
          wget \
          bc \
          unzip \
          git
          
    - name: Install bats-core
      run: |
        if [[ ! -d bats-core-master ]]; then
          echo "==> Downloading bats-core"
          curl -L -O https://github.com/bats-core/bats-core/archive/refs/heads/master.zip
          unzip master.zip
        fi
        
        echo "==> Installing bats-core"
        cd bats-core-master
        sudo ./install.sh /usr/local/
        
        # Verify installation
        bats --version
        
    - name: Verify test environment
      run: |
        echo "==> Verifying test environment"
        echo "Bash version: $(bash --version | head -n1)"
        echo "Date command: $(date --version | head -n1 || echo 'BSD date')"
        echo "BC available: $(command -v bc && bc --version | head -n1 || echo 'BC not available')"
        echo "Bats version: $(bats --version)"
        echo "Working directory: $(pwd)"
        echo "Files present:"
        echo "GH ref name. : ${{github.ref_name }}"
        echo "GH ref.      : ${{github.ref }}"
        ls -la
        
    - name: Run complete test suite
      run: |
        echo "==> Running complete test suite"
        bats tests/*.bats

  test-docker:
    runs-on: ubuntu-latest
    if: false # Disabled by default; enable if Docker tests are needed
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: |
        if [[ -f Dockerfile ]]; then
          echo "==> Building Docker test image"
          docker build -t hhgttg-test .
        else
          echo "No Dockerfile found, skipping Docker tests"
        fi
        
    - name: Run tests in Docker
      run: |
        if docker images | grep -q hhgttg-test; then
          echo "==> Running tests in Docker container"
          docker run -t --rm hhgttg-test
        else
          echo "Docker image not available, skipping Docker tests"
        fi

  compatibility-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, ubuntu-24.04, macos-latest]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies (Ubuntu)
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install -y curl wget bc unzip
        
    - name: Install dependencies (macOS)
      if: startsWith(matrix.os, 'macos')
      run: |
        brew update || true
        brew install bash bc curl wget || true
        
    - name: Install bats-core
      run: |
        curl -L -O https://github.com/bats-core/bats-core/archive/refs/heads/master.zip
        unzip master.zip
        cd bats-core-master
        sudo ./install.sh /usr/local/ || ./install.sh "$HOME/.local"
        
        # Add to PATH if installed in home directory
        if [[ -f "$HOME/.local/bin/bats" ]]; then
          echo "$HOME/.local/bin" >> $GITHUB_PATH
        fi
        
    - name: Verify environment
      run: |
        echo "OS: ${{ matrix.os }}"
        echo "Bash version: $(bash --version | head -n1)"
        echo "Bats version: $(bats --version || echo 'Bats not found in PATH')"
        which bats || echo "Bats location not found"
        
    - name: Run core tests
      if: false # Disabled by default; enable if Docker tests are needed
      run: |
        # Run essential tests that should work on all platforms
        echo "==> Running core compatibility tests"
        
        bats test/test_spinner.bats || echo "Spinner tests failed on ${{ matrix.os }}"
        bats test/test_timers.bats || echo "Timer tests failed on ${{ matrix.os }}"
        
        echo "Compatibility tests completed for ${{ matrix.os }}"

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run shellcheck
      uses: ludeeus/action-shellcheck@master
      with:
        severity: error
        scandir: '.'
        ignore_paths: bats-core-master test_helper 
        
    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ""
        head: ${{ github.ref_name }}
        extra_args: --debug --only-verified


  # -------------------------------------------------
  # Release job
  # -------------------------------------------------
  release:
    # Run only on pushes to the *release* branch (or any branch you prefer)
    if: ( github.ref_name == 'refs/heads/main' || github.ref_name == 'refs/heads/release' || github.ref_name == 'refs/heads/fix/*' ) && success()
    needs:
      - test
      - compatibility-test
      - security-scan
    runs-on: ubuntu-latest
    permissions:
      contents: write      # needed for creating a release & pushing tags
    steps:
      # 1. Checkout the repo (including tags)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # fetch all history so we can read tags

      # 2. Determine the version from the library itself
      #    The library stores its version in config.sh as BASH_UTILS_VERSION [1]
      - name: Get library version
        id: version
        run: |
          # source the file just enough to read the variable – no side‑effects
          VERSION="$(date +%Y.%m.%d)"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      # 3. Configure Git identity
      - name: Configure Git identity
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # 4. Create (or move) a git tag for the release
      - name: Tag the commit
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git tag -a "v${VERSION}" -m "Release ${VERSION}"
          git push origin "v${VERSION}"
        # If the tag already exists the command fails – that’s fine,
        # the release step below will just reuse it.

      # 5. Build a changelog (Changes list)
      #    This example uses the conventional “git log …” format.
      - name: Generate changelog
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Find the previous tag (ignore the one we just created)
          PREV_TAG=$(git tag --sort=-creatordate | grep -E '^v[0-9]' | grep -v "^v${VERSION}$" | head -n1 || echo "")
          if [ -z "$PREV_TAG" ]; then
            RANGE="${{ github.sha }}"
          else
            RANGE="${PREV_TAG}..${{ github.sha }}"
          fi
          echo "## Changes" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          git log --pretty=format:"- %s (%h)" $RANGE >> RELEASE_NOTES.md
          cat RELEASE_NOTES.md
        shell: bash

      # 5. Create the GitHub release
      - name: Create GitHub release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "dolpa‑bash‑library v${{ steps.version.outputs.version }}"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false

      # 6. (Optional) Upload compiled Bash binaries that were built in the matrix
      #    Each matrix run installed a binary under /usr/local/bash‑<ver>/bin/bash.
      #    We can collect them via the `actions/upload-artifact` step in the test job
      #    and then reuse them here, or just ship the source. Below is an example
      #    of uploading the whole `dist/` folder if you create one.
      - name: Upload release assets
        if: steps.create_release.outputs.upload_url != ''
        uses: softprops/action-gh-release@v2
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          files: |
            dist/*.tar.gz          # ← adjust to whatever you actually produce